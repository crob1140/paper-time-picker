<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../neon-animation/neon-animatable.html">
<link rel="import" href="../neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../neon-animation/animations/fade-out-animation.html">
<link rel="import" href="paper-simple-time-picker-dialog-style.html">
<link rel="import" href="../paper-autocomplete/paper-autocomplete.html">

<!--

[Material Design Pickers](http://www.google.com/design/spec/components/pickers.html)

Provides a responsive time picker based on the material design spec. This
component aims to be a clone of the time picker introduced in Android Lollipop.

## Examples:

Default picker:

    <paper-simple-time-picker></paper-simple-time-picker>

Setting the initial time to 4:20pm (note that hours given as 24-hour):

    <paper-simple-time-picker time="4:20pm"></paper-simple-time-picker>

If you include this element as part of `paper-dialog`, use the class
`"paper-simple-time-picker-dialog"` on the dialog in order to give it proper styling.

    <paper-dialog id="dialog" modal class="paper-simple-time-picker-dialog"
      on-iron-overlay-closed="dismissDialog">
      <paper-simple-time-picker id="timePicker" time="[[time]]"></paper-simple-time-picker>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm>OK</paper-button>
      </div>
    </paper-dialog>

@element paper-simple-time-picker
@blurb Provides a responsive time picker based on the material design spec.
@homepage http://bendavis78.github.io/paper-time-picker/
@demo demo/index.html
-->

<style is="custom-style" include="paper-simple-time-picker-dialog-style">
  /* include dialog style at document-level for backward compatibility */
</style>

<dom-module id="paper-simple-time-picker">
  <template>
    <style>
      :host * {
        -webkit-tap-highlight-color: rgba(0,0,0,0);
      }

      :host {
        display: block;
        background-color: var(--primary-background-color);
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        @apply(--paper-font-body1);
        font-size: 14px;
      }

      #timePicker {
        display: flex;
      }

      /** Left Border ****************/
      #left-border {
        box-sizing: border-box;
        width: 30px;
        background: var(--default-primary-color);
        @apply(--layout-vertical);
        @apply(--layout-center-center);
      }

      /** Content ********************/
      #content > iron-selector {
        margin-top: 10px;
      }
      #content .time {
        @apply(--paper-font-display2);
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
        width: 5.34ex;
        letter-spacing: .13ex !important;
      }
      :host([enable-seconds]) #content .time{
        width: 8.5ex;
        font-size: 40px;
      }
      #content .iron-selected {
        color: var(--text-primary-color);
      }
      #content .time div,
      #content .sep {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #content paper-input {
        --paper-input-container-color: var(--light-primary-color);
        --paper-input-container-focus-color: var(--text-primary-color);
        --paper-input-container-input-color: var(--light-primary-color);
        --paper-input-container-input-focus: var(--text-primary-color);
        --paper-input-container-input: {
          @apply(--paper-font-display2);
        }
      }
      #content paper-input.iron-selected {
        --paper-input-container-input-color: var(--text-primary-color);
      }
      #hours-input {
        text-align: right;
      }
      #minutes-input{
        text-align: left;
      }
      paper-autocomplete-suggestions{
        --suggestions-wrapper	:{
          left: 0px;
          right: 0px;
        }
        --suggestions-item:{
          text-align: center;
          display: grid;
        }
      }
    </style>
    <div id="timePicker">
      <div id="left-border">
        <!-- Empty left-border for the colored bar -->
      </div>
      <div id="content">
        <iron-selector id="iron-selector" class="time" selectable="[name]" attr-for-selected="name">
          <paper-input id="hours-input" 
            name="hours" 
            class="hour" 
            maxlength="2" 
            auto-validate 
            allowed-pattern="[0-9]" 
            no-label-float
            on-input="_hoursInputValueChanged"
            on-focus="_inputFocus">
          </paper-input>
          <div class="sep">:</div>
          <paper-input id="minutes-input" 
            name="minutes" class="minute" 
            maxlength="2" 
            auto-validate 
            allowed-pattern="[0-9]" 
            no-label-float
            on-input="_minutesInputValueChanged"
            on-focus="_inputFocus">
          </paper-input>
          <div class="sep" hidden$="[[!enableSeconds]]">:</div>
          <paper-input id="seconds-input" 
            name="seconds" 
            class="second" 
            maxlength="2" 
            auto-validate 
            allowed-pattern="[0-9]" 
            no-label-float
            hidden$="[[!enableSeconds]]"
            on-input="_secondsInputValueChanged"
            on-focus="_inputFocus">
          </paper-input>
        </iron-selector>
        <paper-autocomplete-suggestions class="autocomplete-suggestions" id="autocomplete-hours" for="hours-input" min-length=0 show-results-on-focus="true" max-viewable-items="[[maxViewableItems]]"></paper-autocomplete-suggestions>
        <paper-autocomplete-suggestions class="autocomplete-suggestions" id="autocomplete-minutes" for="minutes-input" min-length=0 show-results-on-focus="true" max-viewable-items="[[maxViewableItems]]"></paper-autocomplete-suggestions>
        <paper-autocomplete-suggestions class="autocomplete-suggestions" id="autocomplete-seconds" for="seconds-input" min-length=0 show-results-on-focus="true" max-viewable-items="[[maxViewableItems]]"></paper-autocomplete-suggestions>
      </div>
    </div>
  </template>
  <script>
    (function() {
      function warn() {
        if (window.console) {
          console.warn.apply(console, arguments);
        }
      }

      Polymer({
        is: 'paper-simple-time-picker',
        properties: {
          /**
           * The selected time
           */
          time: {
            type: String,
            value: '00:00',
            notify: true,
            observer: '_timeChanged'
          },
          /**
           * The current 24-hour value (0-23)
           */
          hour: {
            type: Number,
            observer: '_hourChanged',
            notify: true,
            value: 0
          },
          /**
           * The current minute (0-59)
           */
          minute: {
            type: Number,
            notify: true,
            observer: '_minuteChanged',
            value: 0
          },
          /**
           * The current second (0-59)
           */
          second: {
            type: Number,
            notify: true,
            observer: '_secondChanged',
            value: 0
          },
          /**
           * Show seconds input
           */
           enableSeconds: {
            type: Boolean,
            value: false
          },
          /**
           * Max number of suggestions to be displayed without scrolling
           */
           maxViewableItems: {
            type: Number,
            value: 12
          },
          /**
           * Show the minutes and seconds in these increments
           */
          timeInterval: {
            type: Number,
            value: 5
          },
          /**
           * Use a 12-Hour clock and show AM or PM in the output time
           */
          useTwelveHourClock: {
            type: Boolean,
            value: false
          }
        },
        observers: [
          '_updateTime(hour, minute, second)'
        ],
        attached: function(){
          var autocompleteHours = this.$$('#autocomplete-hours'); 
          var autocompleteMinutes = this.$$('#autocomplete-minutes');
          var autocompleteSeconds = this.$$('#autocomplete-seconds');

          // Override default queryFn with our custom. Only works when done in ready due to possible race condition in the library maybe¯\_(ツ)_/¯
          autocompleteHours.queryFn = this._returnAllResults;
          autocompleteMinutes.queryFn = this._returnAllResults;
          autocompleteSeconds.queryFn = this._returnAllResults;

          // Set options for the dropdowns. Has to be done here otherwise the timeInterval is not available for setting intervals.
          autocompleteHours.source = this._getHoursList();
          autocompleteMinutes.source = this._getMinutesAndSecondsList();
          autocompleteSeconds.source = this._getMinutesAndSecondsList();

          // Set autocomplete-select event, as normally it doesn't do anything if you click an autocomplete item 
          // (it """updates""" the input, but doesn't update any values, doesn't trigger any events and therefore does not cause any observers to fire...)
          autocompleteHours.addEventListener('autocomplete-selected', this._onHourSelected.bind(this));
          autocompleteMinutes.addEventListener('autocomplete-selected', this._onMinuteSelected.bind(this));
          autocompleteSeconds.addEventListener('autocomplete-selected', this._onSecondSelected.bind(this));
        },
        focusHoursInput: function () {
          this.$$('#hours-input').focus();
        },
        _onHourSelected: function(event){
          this.hour = parseInt(event.detail.text);
        },
        _onMinuteSelected: function(event){
          this.minute = parseInt(event.detail.text);
        },
        _onSecondSelected: function(event){
          this.second = parseInt(event.detail.text);        
        },
        _returnAllResults: function (datasource, query) {
          // Must deep copy or it fails to re-open
          var results = [];
          datasource.forEach(function (item) {
            var copyItem = { text: item.text, value: item.value };
            results.push(copyItem);
          })
          return results;
        },
        _updateTime: function () {
          this.time = this._formatTime(this.hour, this.minute, this.second);
        },
        _getHoursList: function () {
          var hoursList = [];
          for (var i = 0; i < 24; i++) {
            // Note - Strings must be used with these "values", as the autocomplete tries to get a "length" of your value.
            // I.e. Number values have no "length" property and will thus fail to produce a suggestion.
            var x = ("" + i);
            hoursList.push({ "text": x, "value": x });
          }
          return hoursList;
        },
        _getMinutesAndSecondsList: function (ev) {
          var numbersList = [];
          for (var i = 0; i < 60; i++) {
            if (i % this.timeInterval === 0) {
            // Note - Strings must be used with these "values", as the autocomplete tries to get a "length" of your value.
            // I.e. Number values have no "length" property and will thus fail to produce a suggestion.
            var x = this._zeroPad(i, 2);
            numbersList.push({ "text": x, "value": x });
            }
          }
          return numbersList;
        },
        _timeChanged: function(time) {
          if (!time) {
            this._setTimeObjects(0,0,0);
            return;
          }
          var parsed = this._parseTimeWithPeriod(time);
          var cleanedTime = this._formatTime(parsed.hour, parsed.minute, parsed.second);
          this._setTimeObjects(parsed.hour, parsed.minute, parsed.second);
        },
        _setTimeObjects:function(hour,min,sec){
          this.hour = hour;
          this.minute = min;
          if (this.enableSeconds) {
            this.second = sec;
          }
        },
        _formatTime: function(hour, minute, second) {
          minute = ('0' + minute).substr(-2);
          second = ('0' + second).substr(-2);
          if (this.enableSeconds) {
            minute += ':' + second;
          }
          var period = "";
          if (this.useTwelveHourClock) {
            if (hour === 0) {
              hour = 12;
              period = "AM";
            } else if (hour === 12) {
              period = "PM";
            } else if (hour > 12) {
              hour = hour - 12;
              period = "PM";
            } else {
              period = "AM";
            }
          } 
          return hour + ':' + minute + " " + period;
        },
        _parseTimeWithPeriod: function(timeString) {
          var pattern = /^\s*(\d{1,2}):?(\d{2})(:?(\d{2}))?(\s*([AaPp])\.?[Mm]\.?|[A-Z])?\s*$/;
          var match = timeString.match(pattern);
          if (!match) {
            warn('Invalid time:', timeString);
            return;
          }
          var hour = parseInt(match[1]);
          var minute = parseInt(match[2]);
          var second = match[4] ? parseInt(match[4]) : 0;
          var period = match[6] ? (match[6][0].toUpperCase() + 'M') : match[6];
          if (period === 'PM' && hour < 12) {
            hour = (hour + 12) % 24;
          } else if (period === 'AM' && hour === 12) {
            hour = 0;
          }
          return {hour: hour, minute: minute, second: second};
        },
        _hourChanged: function(hour, oldValue) {
          hour = parseInt(hour);
          if (isNaN(hour) && !hour) {
            return;
          }
          if (isNaN(hour)) {
            this.hour = oldValue;
            return;
          }
          // To handle 24 and above (even though input limited prevents over 24hr anyway)
          var numberOf24s = parseInt(hour / 24);
          var hoursToSubtract = numberOf24s * 24;
          hour = hour - (hoursToSubtract);

          this.hour = hour;
          this.$['hours-input'].value = "" + hour;
        },
        _hoursInputValueChanged: function () {
          var value = this.$['hours-input'].value;
          if (value > 24) {
            value = value - (parseInt(value / 24) * 24);
            this.$['hours-input'].value = value;
          }
          if (isNaN(value) || !value || value < 0) {
            return;
          }
          this.hour = value;
        },
        _minuteChanged: function(minute) {
          minute = parseFloat(minute) % 60;
          this.minute = minute;
          this.$['minutes-input'].value = this._zeroPad(minute, 2);
        },
        _minutesInputValueChanged: function(value) {
          var value = this.$['minutes-input'].value;
          if (isNaN(value) || !value || value.length < 2 || value > 59) {
            return;
          }
          this.minute = value;  
        },
        _secondChanged: function(second) {
          second = parseFloat(second) % 60;
          this.second = second;
          this.$['seconds-input'].value = this._zeroPad(second, 2);
        },
        _secondsInputValueChanged: function(value) {
          var value = this.$['seconds-input'].value;
          if (isNaN(value) || !value || value.length < 2 || value > 59) {
            return;
          }
          this.second = value;   
        },
        _zeroPad: function(value, length) {
          if (value === undefined || isNaN(value) || isNaN(length)) {
            return;
          }
          return ('0' + value).substr(-length);
        },
        _inputFocus: function(ev) {
          this.$['iron-selector'].selected = ev.target.name;
          ev.target.$.input.select();
        },
        _isEqual: function(a, b) {
          return a === b;
        }
      });
    })();
  </script>
</dom-module>
